/* generated by make_init.pl mod1.h mod2.h mod3.h */

/* includes */
#include "memalloc.h"   			/* before any other include */

#include <stdlib.h>
#include <stdio.h>
#include <glib.h>

#include "init.h"
#undef main							/* define main only in user code */

/* data types */
typedef struct ObjectRegister_store
{
	void (*delete_func)(void **);	/* delete function pointer, NULL if no auto-delete */
} ObjectRegister_store;

#define STORE_ADDR(data)	(((char *)(data))  - sizeof(void*))
#define DATA_ADDR(store)	(((char *)(store)) + sizeof(void*))

/* data store for each managed object */

typedef struct Person_store
{
	void (*delete_func)(Person **);	/* delete function pointer, NULL if no auto-delete */
	Person data;
} Person_store;

typedef struct Person0_store
{
	void (*delete_func)(Person0 **);	/* delete function pointer, NULL if no auto-delete */
	Person0 data;
} Person0_store;

typedef struct Person1_store
{
	void (*delete_func)(Person1 **);	/* delete function pointer, NULL if no auto-delete */
	Person1 data;
} Person1_store;

typedef struct Person2_store
{
	void (*delete_func)(Person2 **);	/* delete function pointer, NULL if no auto-delete */
	Person2 data;
} Person2_store;

typedef struct Person3_store
{
	void (*delete_func)(Person3 **);	/* delete function pointer, NULL if no auto-delete */
	Person3 data;
} Person3_store;


/* global data */
static GList *objects;				/* all registered objects for cleanup at end */

/* declare functions */
extern int 	user_main(int argc, char *argv[]);
static void init();
static void xatexit(void (*fini)(void));
static void objects_init(void);
static void objects_fini(void);
static void register_object(void *object);
static void unregister_object(void *object);
static ObjectRegister_store *first_autodelete(void);


/* Person: create, destroy, set/clear autodelete */
Person * new_Person (  char * name,  int age )
{
	Person_store * self_store = g_slice_new0( Person_store );
	Person       * self       = (Person *) DATA_ADDR( self_store );
	
	autodelete_Person( self, TRUE );

	struct_Person_init( self, name, age );

	register_object( (void*) self_store );

	return self;
}

void delete_Person ( Person **pself )
{
	Person_store * self_store = (Person_store *) STORE_ADDR( *pself );
	
	unregister_object( (void*) self_store );

	struct_Person_fini( *pself );

	g_slice_free( Person_store, self_store );

	*pself = NULL;
}

void autodelete_Person ( Person *self, BOOL autodelete )
{
	Person_store * self_store = (Person_store *) STORE_ADDR( self );
	
	self_store->delete_func = autodelete ? delete_Person : NULL;
}

/* Person0: create, destroy, set/clear autodelete */
Person0 * new_Person0 ( void )
{
	Person0_store * self_store = g_slice_new0( Person0_store );
	Person0       * self       = (Person0 *) DATA_ADDR( self_store );
	
	autodelete_Person0( self, TRUE );

	register_object( (void*) self_store );

	return self;
}

void delete_Person0 ( Person0 **pself )
{
	Person0_store * self_store = (Person0_store *) STORE_ADDR( *pself );
	
	unregister_object( (void*) self_store );

	g_slice_free( Person0_store, self_store );

	*pself = NULL;
}

void autodelete_Person0 ( Person0 *self, BOOL autodelete )
{
	Person0_store * self_store = (Person0_store *) STORE_ADDR( self );
	
	self_store->delete_func = autodelete ? delete_Person0 : NULL;
}

/* Person1: create, destroy, set/clear autodelete */
Person1 * new_Person1 ( void )
{
	Person1_store * self_store = g_slice_new0( Person1_store );
	Person1       * self       = (Person1 *) DATA_ADDR( self_store );
	
	autodelete_Person1( self, TRUE );

	register_object( (void*) self_store );

	return self;
}

void delete_Person1 ( Person1 **pself )
{
	Person1_store * self_store = (Person1_store *) STORE_ADDR( *pself );
	
	unregister_object( (void*) self_store );

	g_slice_free( Person1_store, self_store );

	*pself = NULL;
}

void autodelete_Person1 ( Person1 *self, BOOL autodelete )
{
	Person1_store * self_store = (Person1_store *) STORE_ADDR( self );
	
	self_store->delete_func = autodelete ? delete_Person1 : NULL;
}

/* Person2: create, destroy, set/clear autodelete */
Person2 * new_Person2 ( void )
{
	Person2_store * self_store = g_slice_new0( Person2_store );
	Person2       * self       = (Person2 *) DATA_ADDR( self_store );
	
	autodelete_Person2( self, TRUE );

	register_object( (void*) self_store );

	return self;
}

void delete_Person2 ( Person2 **pself )
{
	Person2_store * self_store = (Person2_store *) STORE_ADDR( *pself );
	
	unregister_object( (void*) self_store );

	g_slice_free( Person2_store, self_store );

	*pself = NULL;
}

void autodelete_Person2 ( Person2 *self, BOOL autodelete )
{
	Person2_store * self_store = (Person2_store *) STORE_ADDR( self );
	
	self_store->delete_func = autodelete ? delete_Person2 : NULL;
}

/* Person3: create, destroy, set/clear autodelete */
Person3 * new_Person3 ( void )
{
	Person3_store * self_store = g_slice_new0( Person3_store );
	Person3       * self       = (Person3 *) DATA_ADDR( self_store );
	
	autodelete_Person3( self, TRUE );

	register_object( (void*) self_store );

	return self;
}

void delete_Person3 ( Person3 **pself )
{
	Person3_store * self_store = (Person3_store *) STORE_ADDR( *pself );
	
	unregister_object( (void*) self_store );

	g_slice_free( Person3_store, self_store );

	*pself = NULL;
}

void autodelete_Person3 ( Person3 *self, BOOL autodelete )
{
	Person3_store * self_store = (Person3_store *) STORE_ADDR( self );
	
	self_store->delete_func = autodelete ? delete_Person3 : NULL;
}


/* get first object in register with autodelete set */
static ObjectRegister_store *first_autodelete(void)
{
	GList *object;
	ObjectRegister_store *data;
	
	for ( object = g_list_first(objects); object; object = g_list_next(object) )
	{
		data = (ObjectRegister_store *) object->data;
		if ( data->delete_func )
			return data;
	}
	return NULL;		
}

/* initialize object register */
static void objects_init(void)
{
	static BOOL initialized = FALSE;

	if ( ! initialized )
	{
		xatexit( objects_fini );
		initialized = TRUE;
	}
}

/* cleanup object register, release all memory */
static void objects_fini(void)
{
	ObjectRegister_store *store;
	void                 *data;
	
	/* search list from start on each iteration, as list may be modified by object delete */
	while ( (store = first_autodelete()) != NULL )
	{
		data = DATA_ADDR(store);
		(store->delete_func)( &data );
	}
	g_list_free( objects );
	objects = NULL;
}

/* register object */
static void register_object ( void *object )
{
	objects_init();
	objects = g_list_prepend( objects, object );
}

/* unregister object */
static void unregister_object ( void *object )
{
	objects_init();
	objects = g_list_remove( objects, object );
}

/* register atexit(), die on error */
static void xatexit(void (*fini)(void))
{
	if (atexit(fini))
	{
		fprintf(stderr, "atexit() failed\n");
		exit(1);
	}
}

/* initialize all modules */
static void init()
{

  
	init_1();
  

  
	xatexit( fini_1 );
  

  
	init_2();
  

  
	xatexit( fini_3 );
  

}

/* new main function to init and call user main */
int main(int argc, char *argv[])
{
    init();
    return user_main(argc, argv);
}